version: '3.8'

services:
  # Workspace container used by the devcontainer. This keeps the workspace
  # available to the other compose services and is the container VS Code
  # will open a shell into.
  dev:
    image: mcr.microsoft.com/devcontainers/python:3.11
    volumes:
      - ./:/workspace:cached
    working_dir: /workspace
    command: sleep infinity
    environment:
      - DEVELOPMENT_ENV=True
    tty: true

  # Flask development server (hot reload)
  web:
    image: mcr.microsoft.com/devcontainers/python:3.11
    volumes:
      - ./:/workspace:cached
    working_dir: /workspace
    command: bash -lc "if [ ! -d .venv ]; then python -m venv .venv; fi; . .venv/bin/activate; if [ ! -f .venv/.requirements_installed ]; then if mkdir .pip_install_lock 2>/dev/null; then pip install --no-cache-dir -r app/requirements.txt && touch .venv/.requirements_installed && rmdir .pip_install_lock; else while [ -d .pip_install_lock ]; do sleep 1; done; fi; fi; flask --app app/main.py run --reload --host=0.0.0.0"
    ports:
      - "5000:5000"
    depends_on:
      - dev

  # Tailwind watch (hot rebuild of tailwind.css)
  tailwind:
    image: node:20-bullseye
    volumes:
      - ./:/workspace:cached
    working_dir: /workspace
    command: bash -lc "if [ ! -d node_modules ]; then if mkdir .npm_install_lock 2>/dev/null; then npm install --no-audit --no-fund && rmdir .npm_install_lock; else while [ -d .npm_install_lock ]; do sleep 1; done; fi; fi; npx tailwindcss -i ./app/static/css/style.css -o ./app/static/css/tailwind.css --watch"
    depends_on:
      - dev
