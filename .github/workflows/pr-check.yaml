name: On PR workflow

on:
  pull_request:
    branches: [main]

jobs:
  quality-check:
    name: Lint, Build & Validate
    runs-on: ubuntu-latest
    steps:
      # 1. Get the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Prettier
      - name: Check Formatting (Prettier)
        run: npx prettier --check "**/*.{js,css,njk,html,md,json}"

      # 5. Lint JavaScript
      - name: Lint JS (ESLint)
        run: npx eslint . 

      # 6. Verify Nunjucks & 11ty Build
      - name: Build 11ty Site
        run: npx @11ty/eleventy
        env:
          NODE_ENV: production

      # 8. Validate HTML Output
      - name: Validate Generated HTML
        run: npx html-validate "_site/**/*.html"
  
  spawn-preview:
    name: Create a temporary preview page
    runs-on: ubuntu-latest
    needs: quality-check
    permissions:
      contents: "read"
      id-token: "write" # Required for Workload Identity Federation
    env:
      PROJECT_ID: ${{ vars.GCL_PROJECT }}
    outputs:
      WEB_APP_URL: ${{ steps.create-preview.outputs.WEB_APP_URL }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Node
        uses: actions/setup-node@v4
        with: 
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Build minified css
        run: npx tailwindcss -i app/static/css/style.css -o app/static/css/tailwind.css --minify
      - name: Build 11ty Site
        run: npx @11ty/eleventy
        env:
          NODE_ENV: production
      - name: Authenticate with Google Cloud
        id: "auth"
        uses: "google-github-actions/auth@v3"
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Create a preview version
        id: "create-preview"
        run: |
          npm install -g firebase-tools
          firebase \
            hosting:channel:deploy ${{ github.event.number }} \
            --project ${{ env.PROJECT_ID }} \
            --expires 24h \
            | grep -o "https://${{ env.PROJECT_ID }}--${{ github.event.number }}-.*\.web\.app" \
            | sed "s/^/WEB_APP_URL=/" \
            | cat >> "$GITHUB_OUTPUT"
  send-comment:
    name: Create an output comment
    runs-on: ubuntu-latest
    needs: spawn-preview
    permissions:
      issues: "read"
      pull-requests: "write"
    steps:
      - name: Find Comment - if exists
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Preview version created!
      - name: Create comment with link to preview
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Preview version created! 
            You can check it out [here](${{ needs.spawn-preview.outputs.WEB_APP_URL }})
          edit-mode: replace
  check-lighthouse:
    name: Run lighthouse CI
    runs-on: ubuntu-latest
    needs: spawn-preview
    steps:
      - uses: actions/checkout@v5
      - name: Test Lighthouse CI score
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ needs.spawn-preview.outputs.WEB_APP_URL }}
          runs: 3
          uploadArtifacts: true
          configPath: .github/workflows/lighthouserc.json
  post-lighthouse:
    name: Create comment with link to lighthouse score page
    runs-on: ubuntu-latest
    needs: check-lighthouse
    if: ${{ always() }} # This is mostly because we kinda have to get data out even if checks fail
    permissions:
      issues: "read"
      pull-requests: "write"
    steps:
      - name: Find Comment - if exists
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: LighthouseCI tests ran!
      - name: Create comment with link to preview
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            LighthouseCI tests ran!
            [You can check them out from run#${{ github.run_id }} page ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace
  link-check:
    name: Check the links for any dead ones
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Node
        uses: actions/setup-node@v4
        with: 
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Build minified css
        run: npx tailwindcss -i app/static/css/style.css -o app/static/css/tailwind.css --minify
      - name: Build 11ty Site
        run: npx @11ty/eleventy --serve & sleep 5
        env:
          NODE_ENV: production
      - name: Run link-check
        uses: filiph/linkcheck@2.0.23
        with: 
          arguments: "-e"
